<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üîß –†–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ–≥—Ä–∞–º–º</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* ... (—Ç–æ—Ç –∂–µ CSS, —á—Ç–æ –∏ —Ä–∞–Ω—å—à–µ) ... */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #121212;
            color: #e0e0e0;
            font-size: 13px;
            padding: 10px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #1976d2;
            margin-bottom: 20px;
        }
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 8px 16px;
            background: #333;
            border: none;
            color: #ddd;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background: #1976d2;
            color: white;
        }
        .form-section {
            display: none;
            background: #1e1e1e;
            padding: 16px;
            border: 1px solid #333;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-section.active {
            display: block;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #bbb;
        }
        input, select, button {
            padding: 6px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #333;
            color: #fff;
            font-size: 13px;
        }
        input[readonly] {
            background: #2a2a2a;
            color: #888;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
        }
        button:hover {
            background: #0d47a1;
        }
        .step {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: #2a2a2a;
            border-radius: 6px;
        }
        .step button {
            padding: 4px 8px;
            font-size: 12px;
        }
        .time-summary {
            font-size: 14px;
            color: #64b5f6;
            margin: 10px 0;
            font-weight: 500;
        }
        .actions {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }
        .btn {
            background: #43a047;
        }
        .btn-secondary {
            background: #fb8c00;
        }
        .btn-danger {
            background: #e53935;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –†–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ–≥—Ä–∞–º–º</h1>

        <div class="tabs">
            <button class="tab active" data-tab="press1">–ü—Ä–µ—Å—Å 1</button>
            <button class="tab" data-tab="press2">–ü—Ä–µ—Å—Å 2</button>
            <button class="tab" data-tab="press3">–ü—Ä–µ—Å—Å 3</button>
        </div>

        <div id="press1" class="form-section active">
            <h3>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</h3>
            <div id="tempSteps1"></div>
            <button type="button" onclick="addTempStep(1)">+ –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥</button>
            <div class="time-summary" id="tempTime1">–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: 0 —Å</div>

            <h3>–î–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div id="pressSteps1"></div>
            <button type="button" onclick="addPressStep(1)">+ –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥</button>
            <div class="time-summary" id="pressTime1">–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: 0 —Å</div>

            <div class="actions">
                <button class="btn" onclick="saveCurrent(1)">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="saveAsCurrent(1)">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫‚Ä¶</button>
                <button class="btn btn-danger" onclick="loadIntoPress(1)">üìÇ –û—Ç–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="press2" class="form-section">
            <!-- –ü–æ–≤—Ç–æ—Ä –¥–ª—è –ø—Ä–µ—Å—Å–∞ 2 -->
            <h3>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</h3>
            <div id="tempSteps2"></div>
            <button type="button" onclick="addTempStep(2)">+ –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥</button>
            <div class="time-summary" id="tempTime2">–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: 0 —Å</div>

            <h3>–î–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div id="pressSteps2"></div>
            <button type="button" onclick="addPressStep(2)">+ –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥</button>
            <div class="time-summary" id="pressTime2">–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: 0 —Å</div>

            <div class="actions">
                <button class="btn" onclick="saveCurrent(2)">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="saveAsCurrent(2)">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫‚Ä¶</button>
                <button class="btn btn-danger" onclick="loadIntoPress(2)">üìÇ –û—Ç–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="press3" class="form-section">
            <!-- –ü–æ–≤—Ç–æ—Ä –¥–ª—è –ø—Ä–µ—Å—Å–∞ 3 -->
            <h3>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</h3>
            <div id="tempSteps3"></div>
            <button type="button" onclick="addTempStep(3)">+ –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥</button>
            <div class="time-summary" id="tempTime3">–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: 0 —Å</div>

            <h3>–î–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div id="pressSteps3"></div>
            <button type="button" onclick="addPressStep(3)">+ –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥</button>
            <div class="time-summary" id="pressTime3">–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: 0 —Å</div>

            <div class="actions">
                <button class="btn" onclick="saveCurrent(3)">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="saveAsCurrent(3)">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫‚Ä¶</button>
                <button class="btn btn-danger" onclick="loadIntoPress(3)">üìÇ –û—Ç–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const stepLabels = {
            'ramp_temp': '–ù–∞–≥—Ä–µ–≤ –¥–æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã',
            'hold': '–í—ã–¥–µ—Ä–∂–∫–∞',
            'cool': '–û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ',
            'ramp_pressure': '–ü–æ–¥–∞—á–∞ –¥–∞–≤–ª–µ–Ω–∏—è',
            'lift_to_limit': '–ü–æ–¥—ä—ë–º –¥–æ —É–ø–æ—Ä–∞',
            'open_mold': '–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É',
            'pause': '–ü–∞—É–∑–∞',
            'set_pressure': '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–≤–ª–µ–Ω–∏–µ'
        };

        const reverseLabels = Object.fromEntries(Object.entries(stepLabels).map(([k, v]) => [v, k]));

        const programs = {
            press1: { temp_program: [], pressure_program: [] },
            press2: { temp_program: [], pressure_program: [] },
            press3: { temp_program: [], pressure_program: [] }
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ–≥—Ä–∞–º–º
        fetch('/get_programs')
            .then(r => r.json())
            .then(data => {
                Object.keys(data).forEach(k => {
                    programs[k] = data[k];
                });
                renderAll();
            });

        function renderAll() {
            for (let pid = 1; pid <= 3; pid++) {
                renderTempSteps(pid);
                renderPressSteps(pid);
                updateTimes(pid);
            }
        }

        function renderTempSteps(pid) {
            const container = document.getElementById(`tempSteps${pid}`);
            container.innerHTML = '';
            programs[`press${pid}`].temp_program.forEach((step, i) => {
                const div = document.createElement('div');
                div.className = 'step';
                div.innerHTML = `
                    <select onchange="updateStep(this, 'temp', ${pid}, ${i})">
                        ${Object.values(stepLabels).map(label => `
                            <option value="${label}" ${stepLabels[step.step] === label ? 'selected' : ''}>${label}</option>
                        `).join('')}
                    </select>
                    <input type="number" placeholder="–¶–µ–ª—å (¬∞C)" value="${step.target_temp || ''}" step="0.1" onchange="updateStep(this, 'temp', ${pid}, ${i})">
                    <input type="number" placeholder="–í—Ä–µ–º—è –ø–æ–¥—ä—ë–º–∞ (—Å)" value="${step.ramp_time || ''}" onchange="updateStep(this, 'temp', ${pid}, ${i})">
                    <input type="number" placeholder="–í—ã–¥–µ—Ä–∂–∫–∞ (—Å)" value="${step.hold_time || ''}" onchange="updateStep(this, 'temp', ${pid}, ${i})">
                    <button onclick="removeTempStep(${pid}, ${i})">‚Äì</button>
                `;
                container.appendChild(div);
            });
        }

        function renderPressSteps(pid) {
            const container = document.getElementById(`pressSteps${pid}`);
            container.innerHTML = '';
            programs[`press${pid}`].pressure_program.forEach((step, i) => {
                const div = document.createElement('div');
                div.className = 'step';
                const target = step.target_pressure !== undefined ? step.target_pressure : '';
                const ramp = step.ramp_time !== undefined ? step.ramp_time : '';
                const hold = step.hold_time !== undefined ? step.hold_time : '';

                div.innerHTML = `
                    <select onchange="updatePressStepType(this, ${pid}, ${i})">
                        ${Object.values(stepLabels).map(label => `
                            <option value="${label}" ${stepLabels[step.step] === label ? 'selected' : ''}>${label}</option>
                        `).join('')}
                    </select>
                    <input type="number" placeholder="–¶–µ–ª—å (–ú–ü–∞)" value="${target}" step="0.1" onchange="updateStep(this, 'press', ${pid}, ${i})" ${['lift_to_limit', 'open_mold'].includes(step.step) ? 'disabled' : ''}>
                    <input type="number" placeholder="–í—Ä–µ–º—è (—Å)" value="${ramp}" onchange="updateStep(this, 'press', ${pid}, ${i})" ${['lift_to_limit', 'open_mold'].includes(step.step) ? 'disabled' : ''}>
                    <input type="number" placeholder="–í—ã–¥–µ—Ä–∂–∫–∞ (—Å)" value="${hold}" onchange="updateStep(this, 'press', ${pid}, ${i})" ${['lift_to_limit', 'open_mold'].includes(step.step) ? 'disabled' : ''}>
                    <button onclick="removePressStep(${pid}, ${i})">‚Äì</button>
                `;
                container.appendChild(div);
            });
        }

        function updatePressStepType(select, pid, i) {
            const label = select.value;
            const stepKey = reverseLabels[label];
            const step = programs[`press${pid}`].pressure_program[i];
            step.step = stepKey;

            if (['lift_to_limit', 'open_mold'].includes(stepKey)) {
                step.target_pressure = undefined;
                step.ramp_time = undefined;
                step.hold_time = undefined;
            }
            renderPressSteps(pid);
        }

        function updateStep(input, type, pid, i) {
            const step = type === 'temp'
                ? programs[`press${pid}`].temp_program[i]
                : programs[`press${pid}`].pressure_program[i];

            const val = input.value !== '' ? parseFloat(input.value) : undefined;
            if (input.placeholder.includes('–¶–µ–ª—å')) {
                if (type === 'temp') step.target_temp = val;
                else step.target_pressure = val;
            } else if (input.placeholder.includes('–ø–æ–¥—ä—ë–º–∞') || input.placeholder.includes('–í—Ä–µ–º—è')) {
                step.ramp_time = val;
            } else if (input.placeholder.includes('–í—ã–¥–µ—Ä–∂–∫–∞')) {
                step.hold_time = val;
            }
            updateTimes(pid);
        }

        function addTempStep(pid) {
            programs[`press${pid}`].temp_program.push({
                step: 'ramp_temp',
                target_temp: 50,
                ramp_time: 300,
                hold_time: 300
            });
            renderTempSteps(pid);
            updateTimes(pid);
        }

        function addPressStep(pid) {
            programs[`press${pid}`].pressure_program.push({
                step: 'ramp_pressure',
                target_pressure: 5.0,
                ramp_time: 60,
                hold_time: 180
            });
            renderPressSteps(pid);
            updateTimes(pid);
        }

        function removeTempStep(pid, i) {
            programs[`press${pid}`].temp_program.splice(i, 1);
            renderTempSteps(pid);
            updateTimes(pid);
        }

        function removePressStep(pid, i) {
            programs[`press${pid}`].pressure_program.splice(i, 1);
            renderPressSteps(pid);
            updateTimes(pid);
        }

        function updateTimes(pid) {
            const tempSum = programs[`press${pid}`].temp_program.reduce((sum, s) => sum + (s.ramp_time || 0) + (s.hold_time || 0), 0);
            const pressSum = programs[`press${pid}`].pressure_program.filter(s => s.ramp_time).reduce((sum, s) => sum + (s.ramp_time || 0) + (s.hold_time || 0), 0);
            document.getElementById(`tempTime${pid}`).textContent = `–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ${formatTime(tempSum)}`;
            document.getElementById(`pressTime${pid}`).textContent = `–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ${formatTime(pressSum)}`;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins} –º–∏–Ω ${secs} —Å`;
        }

        // ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–µ—Å—Å
        function saveCurrent(pressId) {
            const program = programs[`press${pressId}`];
            fetch('/save_press', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ press_id: pressId, program: program })
            }).then(() => alert(`‚úÖ –ü—Ä–µ—Å—Å-${pressId} —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ press${pressId}.json`));
        }

        // ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫‚Ä¶ (–±—Ä–∞—É–∑–µ—Ä–Ω—ã–π –¥–∏–∞–ª–æ–≥)
        function saveAsCurrent(pressId) {
            const program = programs[`press${pressId}`];
            const data = JSON.stringify(program, null, 4);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `press${pressId}_backup.json`;
            a.click();
        }

        // ‚úÖ –û—Ç–∫—Ä—ã—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤ —Ç–µ–∫—É—â–∏–π –ø—Ä–µ—Å—Å
        async function loadIntoPress(pressId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async () => {
                const file = input.files[0];
                const text = await file.text();
                const loaded = JSON.parse(text);
                programs[`press${pressId}`] = loaded;
                renderTempSteps(pressId);
                renderPressSteps(pressId);
                updateTimes(pressId);
            };
            input.click();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });
    </script>
</body>
</html>