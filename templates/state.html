<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #121212;
            color: #e0e0e0;
            font-size: 13px;
            padding: 10px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #1976d2;
            margin-bottom: 20px;
        }
        .btn-back {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #1976d2;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 12px;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .btn-back:hover {
            background: #0d47a1;
        }
        .section {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .press-section {
            padding: 16px;
            background: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-family: monospace;
        }
        .label {
            color: #aaa;
            width: 200px;
            display: inline-block;
        }
        .value {
            color: #64b5f6;
            font-weight: 500;
        }
        .status-running {
            color: #81c784;
        }
        .status-paused {
            color: #ffb74d;
        }
        .status-stopped {
            color: #e57373;
        }
        .temps {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .temp-item {
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã (Global State)</h1>
        <a href="/" class="btn-back">‚Üê –ù–∞–∑–∞–¥</a>

        <div id="stateContainer">
            <!-- –ü—Ä–µ—Å—Å—ã –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ -->
        </div>
    </div>

    <script>
        const container = document.getElementById('stateContainer');

        function renderState(data) {
            container.innerHTML = '';

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–µ—Å—Å–∞–º
            const presses = [1, 2, 3];
            presses.forEach(pid => {
                const pressDiv = document.createElement('div');
                pressDiv.className = 'press-section';

                const running = data[`press_${pid}_running`] === true;
                const paused = data[`press_${pid}_paused`] === true;
                const statusClass = running ? (paused ? 'status-paused' : 'status-running') : 'status-stopped';
                const statusText = running ? (paused ? '–ü–ê–£–ó–ê' : '–†–ê–ë–û–¢–ê–ï–¢') : '–û–°–¢–ê–ù–û–í–õ–ï–ù';

                const temps = data[`press_${pid}_temps`] || [];
                const pressure = data[`press_${pid}_pressure`] || 0;
                const targetTemp = data[`press_${pid}_target_temp`] || 'N/A';
                const targetPressure = data[`press_${pid}_target_pressure`] || 'N/A';

                // –¢–µ–∫—É—â–∏–µ —à–∞–≥–∏
                const tempStep = data[`press_${pid}_current_step_temperature`] || {};
                const pressStep = data[`press_${pid}_current_step_pressure`] || {};

                const cycleTime = Math.round(data[`press_${pid}_cycle_elapsed`] || 0);

                pressDiv.innerHTML = `
                    <h3>üîß –ü—Ä–µ—Å—Å ${pid+1} <span class="${statusClass}">${statusText}</span></h3>

                    <div class="info-row">
                        <span class="label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</span>
                        <span class="temps">${temps.slice(0,7).map(t => `<span class="temp-item">${t?.toFixed(1)}¬∞C</span>`).join('')}</span>
                    </div>

                    <div class="info-row">
                        <span class="label">–î–∞–≤–ª–µ–Ω–∏–µ:</span>
                        <span class="value">${pressure.toFixed(3)} –ú–ü–∞ ‚Üí ${targetPressure} –ú–ü–∞</span>
                    </div>

                    <div class="info-row">
                        <span class="label">–ù–∞–≥—Ä–µ–≤:</span>
                        <span class="value">${targetTemp} ¬∞C</span>
                    </div>

                    <div class="info-row">
                        <span class="label">–¶–∏–∫–ª:</span>
                        <span class="value">${formatTime(cycleTime)}</span>
                    </div>

                    <div class="section">
                        <h4>üîÑ –¢–µ–∫—É—â–∏–π —à–∞–≥</h4>
                        <div class="info-row">
                            <span class="label">–¢–µ–º–ø:</span>
                            <span>${tempStep.index !== undefined ? `${tempStep.index+1}: ${tempStep.type}` : '‚Äî'}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">–î–∞–≤–ª:</span>
                            <span>${pressStep.index !== undefined ? `${pressStep.index+1}: ${pressStep.type}` : '‚Äî'}</span>
                        </div>
                    </div>

                    <div class="section">
                        <h4>‚öôÔ∏è –ö–ª–∞–ø–∞–Ω—ã</h4>
                        <div class="info-row">
                            <span class="label">–ü–æ–¥—ä—ë–º:</span>
                            <span>${data[`press_${pid}_valve_lift_up`] ? '‚¨ÜÔ∏è –í–ö–õ' : '‚èπÔ∏è –í–´–ö–õ'}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">–û–ø—É—Å–∫–∞–Ω–∏–µ:</span>
                            <span>${data[`press_${pid}_valve_lift_down`] ? '‚¨áÔ∏è –í–ö–õ' : '‚èπÔ∏è –í–´–ö–õ'}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">–û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã:</span>
                            <span>${data[`press_${pid}_valve_open`] ? 'üîì –í–ö–õ' : '‚èπÔ∏è –í–´–ö–õ'}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">–ó–∞–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã:</span>
                            <span>${data[`press_${pid}_valve_close`] ? 'üîí –í–ö–õ' : '‚èπÔ∏è –í–´–ö–õ'}</span>
                        </div>
                    </div>
                `;
                container.appendChild(pressDiv);
            });

            // DCON —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const dcon = data.dcon_stats || {};
            const dconDiv = document.createElement('div');
            dconDiv.className = 'section';
            dconDiv.innerHTML = `
                <h3>üì° DCON –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="info-row">
                    <span class="label">–ö–∞—á–µ—Å—Ç–≤–æ:</span>
                    <span class="value">${dcon.quality?.toFixed(1)}%</span>
                </div>
                <div class="info-row">
                    <span class="label">–°–∫–æ—Ä–æ—Å—Ç—å:</span>
                    <span class="value">${dcon.speed?.toFixed(1)} –∫–æ–º/—Å</span>
                </div>
                <div class="info-row">
                    <span class="label">–í—Å–µ–≥–æ:</span>
                    <span>${dcon.total}</span>
                </div>
            `;
            container.appendChild(dconDiv);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function fetchState() {
            fetch('/get_state')
                .then(r => r.json())
                .then(data => {
                    renderState(data);
                })
                .catch(e => {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:", e);
                    container.innerHTML = "<div class='error'>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ</div>";
                });
        }

        // –ü–µ—Ä–≤—ã–π —Ä–∞–∑ ‚Äî —Å—Ä–∞–∑—É
        fetchState();

        // –ü–æ—Ç–æ–º ‚Äî –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫
        setInterval(fetchState, 2000);
    </script>
</body>
</html>