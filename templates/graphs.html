<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üìà –ê–ü–ê–¢–ï–ö ‚Äî –ì—Ä–∞—Ñ–∏–∫–∏</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #121212;
            color: #e0e0e0;
            font-size: 13px;
            padding: 10px;
        }
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0 12px;
            border-bottom: 1px solid #333;
            margin-bottom: 16px;
        }
        .header-bar h1 {
            font-size: 18px;
            font-weight: 600;
        }
        a {
            color: #64b5f6;
            text-decoration: none;
            font-size: 13px;
        }
        .chart-container {
    background: #1e1e1e;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 16px;
    display: flex;
    flex-direction: column;
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä–∞—Ñ–∏–∫–∞ */
.chart-container h3 {
    font-size: 14px;
    color: #bbb;
    margin-bottom: 8px;
    user-select: none;
}

/* –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è canvas ‚Äî —Ç–µ–ø–µ—Ä—å —Ä–µ—Å–∞–π–∑–∏—Ç—Å—è */
.chart-wrapper {
    position: relative;
    flex-grow: 1;
    min-height: 240px;        /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
    max-height: 800px;        /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
    overflow: hidden;
        /* üî• –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –≤—ã—Å–æ—Ç—ã */
    transition: height 0.2s ease-out;
}

canvas {
    width: 100% !important;
    height: 100% !important;
    display: block;
}

/* –†—É—á–∫–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã */
.resize-handle {
    height: 6px;
    background: linear-gradient(to right, #333, #555, #333);
    cursor: ns-resize;
    border-radius: 3px;
    margin: 6px 0 0;
    user-select: none;
    opacity: 0.6;
}

.resize-tooltip {
    position: absolute;
    top: -32px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 4px;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    z-index: 10;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}

.resize-handle:hover .resize-tooltip {
    opacity: 1;
}
.resize-handle.active {
    background: linear-gradient(to right, #ff5722, #ff9800, #ff5722);
    opacity: 1;
}
    </style>
</head>
<body>
    <div class="header-bar">
        <h1>üìà –ê–ü–ê–¢–ï–ö ‚Äî –ì—Ä–∞—Ñ–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h1>
        <a href="{{ url_for('index') }}">‚Üê –ù–∞–∑–∞–¥</a>
    </div>

    {% for pid in [1, 2, 3] %}
    <div class="chart-container">
        <h3>–ü—Ä–µ—Å—Å {{ pid + 1 }}</h3>
        <div class="chart-wrapper">
            <canvas id="chart{{ pid }}"></canvas>
        </div>
        <div class="resize-handle" data-chart="chart{{ pid }}">
            <span class="resize-tooltip">‚áÖ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –≤—ã—Å–æ—Ç—É</span>
        </div>
        </div>
    </div>
    {% endfor %}

<!-- ‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã (–±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞) -->
<script src="{{ url_for('static', filename='js/chart.umd.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chartjs-adapter-date-fns.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/chartjs-plugin-zoom.min.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const dataStream = new EventSource('/stream_g');
    const maxDataPoints = 2000;
    const tempColors = ['#f44336', '#ff9800', '#4caf50', '#2196f3', '#9c27b0', '#ffeb3b', '#00bcd4'];
    const charts = {};

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    [1, 2, 3].forEach(pid => {
        const canvas = document.getElementById(`chart${pid}`);
        if (!canvas) return;

        // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–º –≥—Ä–∞—Ñ–∏–∫–æ–≤ ===
let isResizing = null;
let startY, startHeight;

document.querySelectorAll('.resize-handle').forEach(handle => {
    const chartId = handle.dataset.chart;
    const wrapper = handle.previousElementSibling;
    const chart = charts[parseInt(chartId.replace('chart', ''))];

    // –£—Å—Ç–∞–Ω–æ–≤–∏–º –Ω–∞—á–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –∏–∑ localStorage (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    const savedHeight = localStorage.getItem(`chart-height-${chartId}`);
    if (savedHeight) {
        wrapper.style.height = savedHeight + 'px';
    } else {
        wrapper.style.height = '250px'; // –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }

    handle.addEventListener('mousedown', e => {
        isResizing = { handle, wrapper, chart };
        startY = e.clientY;
        startHeight = wrapper.offsetHeight;
        document.body.style.cursor = 'ns-resize';
        e.preventDefault();
        handle.classList.add('active');
    });
});

document.addEventListener('mousemove', e => {
    if (!isResizing) return;
    const dy = e.clientY - startY;
    const newHeight = Math.max(200, startHeight + dy); // –º–∏–Ω. 200px
    isResizing.wrapper.style.height = newHeight + 'px';

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã—Å–æ—Ç—É
    const chartId = isResizing.handle.dataset.chart;
    localStorage.setItem(`chart-height-${chartId}`, newHeight);

    // –£–≤–µ–¥–æ–º–ª—è–µ–º Chart.js, —á—Ç–æ —Ä–∞–∑–º–µ—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è
    if (isResizing.chart && typeof isResizing.chart.resize === 'function') {
        isResizing.chart.resize();
    }
});

document.addEventListener('mouseup', () => {
    if (isResizing) {
    isResizing.handle.classList.remove('active');
    document.body.style.cursor = '';
    isResizing = null;
}
});

        const data = {
            datasets: [
                // –£—Å—Ç–∞–≤–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
                {
                    label: '–£—Å—Ç–∞–≤–∫–∞ ¬∞C',
                    data: [],
                    borderColor: '#64b5f6',
                    borderDash: [5, 5],
                    borderWidth: 2,
                    pointRadius: 0,
                    yAxisID: 'y-temp'
                },
                // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∑–æ–Ω 1‚Äì7
                ...Array.from({ length: 7 }, (_, i) => ({
                    label: `–ó–æ–Ω–∞ ${i+1}`,
                    data: [],
                    borderColor: tempColors[i],
                    borderWidth: 1.5,
                    pointRadius: 0,
                    yAxisID: 'y-temp'
                })),
                // –£—Å—Ç–∞–≤–∫–∞ –¥–∞–≤–ª–µ–Ω–∏—è
                {
                    label: '–£—Å—Ç. –¥–∞–≤–ª. –ú–ü–∞',
                    data: [],
                    borderColor: '#8d6e63',
                    borderDash: [5, 5],
                    borderWidth: 2,
                    yAxisID: 'y-pressure'
                },
                // –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ
                {
                    label: '–§–∞–∫—Ç. –¥–∞–≤–ª. –ú–ü–∞',
                    data: [],
                    borderColor: '#43a047',
                    borderWidth: 1.5,
                    pointRadius: 0,
                    yAxisID: 'y-pressure'
                },
                // –í—Ä–µ–º—è —Ü–∏–∫–ª–∞ (–≤ –º–∏–Ω—É—Ç–∞—Ö)
                {
                    label: '–¶–∏–∫–ª, –º–∏–Ω',
                    data: [],
                    borderColor: '#ffa726',
                    borderWidth: 1,
                    borderDash: [3, 3],
                    pointRadius: 0,
                    yAxisID: 'y-cycle'
                }
            ]
        };

        charts[pid] = new Chart(canvas, {
            type: 'line',
            data: data,
            options: {
                maintainAspectRatio: false,
                devicePixelRatio: 2,
                animation: false,
                scales: {
                    x: {
                        type: 'time',
                        offset: false,
                        bounds: 'data',  // –∏–ª–∏ 'ticks' ‚Äî —Ä–∞–∑–Ω–∏—Ü–∞ —Ç–æ–Ω–∫–∞—è: data = –ø–æ —Ç–æ—á–∫–∞–º, ticks = –ø–æ –º–µ—Ç–∫–∞–º
                        time: {
                            unit: 'second',  // –ª—É—á—à–µ –¥–ª—è –ø–ª–æ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                            stepSize: 60,    // –æ–¥–Ω–∞ –º–µ—Ç–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                            displayFormats: {
                                second: 'HH:mm:ss',
                                minute: 'HH:mm'
                            },
                            tooltipFormat: 'dd.MM HH:mm:ss'
                        },
                        title: { display: true, text: '–í—Ä–µ–º—è', color: '#bbb' },
                        ticks: { color: '#bbb', autoSkip: true, maxRotation: 0, padding: 2 },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    'y-temp': {
                        position: 'left',
                        title: { display: true, text: '–¢–µ–º–ø. (¬∞C)', color: '#64b5f6' },
                        suggestedMin: 0,
                        suggestedMax: 200,
                        ticks: { color: '#64b5f6' },
                        grid: { color: 'rgba(100,181,246,0.1)' }
                    },
                    'y-pressure': {
                        position: 'right',
                        title: { display: true, text: '–î–∞–≤–ª. (–ú–ü–∞)', color: '#8d6e63' },
                        suggestedMin: 0,
                        suggestedMax: 10,
                        ticks: { color: '#8d6e63' },
                        grid: { drawOnChartArea: false }
                    },
                    'y-cycle': {
                        position: 'right',
                        offset: true,
                        title: { display: true, text: '–¶–∏–∫–ª (–º–∏–Ω)', color: '#ffa726' },
                        suggestedMin: 0,
                        ticks: { color: '#ffa726' }
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: '#1e1e1e',
                        titleColor: '#fff',
                        bodyColor: '#e0e0e0',
                        borderColor: '#444',
                        borderWidth: 1,
                        cornerRadius: 4,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y;
                                if (value === null) return label + ': ‚Äî';

                                if (label.includes('–¥–∞–≤–ª')) {
                                    return `${label}: ${value.toFixed(2)} –ú–ü–∞`;
                                } else if (label === '–¶–∏–∫–ª, –º–∏–Ω') {
                                    return `${label}: ${value.toFixed(1)} –º–∏–Ω`;
                                } else if (label.includes('–£—Å—Ç–∞–≤–∫–∞')) {
                                    return `${label}: ${value.toFixed(1)} ¬∞C`;
                                } else {
                                    return `${label}: ${value.toFixed(1)} ¬∞C`;
                                }
                            }
                        }
                    },
                    legend: { labels: { color: '#e0e0e0' } },
                    zoom: {
                        zoom: {
                            wheel: { enabled: true },
                            pinch: { enabled: true },
                            mode: 'x'
                        },
                        pan: {
                            enabled: true,
                            mode: 'x'
                        }
                    }
                }
            }
        });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–æ–∫–∞
    dataStream.onmessage = function(event) {
        try {
            const packet = JSON.parse(event.data);
            const nowDate = new Date(); // –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞

            packet.presses.forEach(p => {
                const chart = charts[p.id];
                if (!chart) return;

                const ct_minutes = p.current_step?.cycle_time ? (p.current_step.cycle_time / 60) : null;

                // –ü–∞—Ä—Å–∏–º timestamp ‚Üí –¥–∞—Ç–∞ + –≤—Ä–µ–º—è

                const [h, m, s] = packet.timestamp.split(':').map(Number);
                const pointTime = new Date(
                    nowDate.getFullYear(),
                    nowDate.getMonth(),
                    nowDate.getDate(),
                    h, m, s
                );

                // –ü–æ–º–æ—â–Ω–∏–∫: –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á–∏—Å–ª–æ
                const safeNum = (val) => {
                    if (val === null || val === undefined || val === "‚Äî" || isNaN(val)) return null;
                    return parseFloat(val);
                };

                const datasets = chart.data.datasets;

                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ä—è–¥—ã
                datasets[0].data.push({ x: pointTime, y: safeNum(p.temp_target) });           // —É—Å—Ç–∞–≤–∫–∞ —Ç–µ–º–ø
                for (let i = 0; i < 7; i++) {
                    datasets[i + 1].data.push({ x: pointTime, y: safeNum(p.temps[i]) });      // –∑–æ–Ω—ã
                }
                datasets[8].data.push({ x: pointTime, y: safeNum(p.pressure_target) });       // —É—Å—Ç–∞–≤–∫–∞ –¥–∞–≤–ª
                datasets[9].data.push({ x: pointTime, y: safeNum(p.pressure) });              // —Ñ–∞–∫—Ç. –¥–∞–≤–ª
                datasets[10].data.push({ x: pointTime, y: ct_minutes });                      // —Ü–∏–∫–ª –≤ –º–∏–Ω

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
                datasets.forEach(ds => {
                    while (ds.data.length > maxDataPoints) {
                        ds.data.shift();
                    }
                });

                // –ê–≤—Ç–æ-–º–∞—Å—à—Ç–∞–± –ø–æ X: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç
                //const latest = pointTime.getTime();
                //chart.options.scales.x.min = new Date(latest - 5 * 60 * 1000); // 5 –º–∏–Ω –Ω–∞–∑–∞–¥
                //chart.options.scales.x.max = new Date(latest + 30 * 1000);     // +30 —Å–µ–∫

                chart.update('quiet');
            });
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", e);
        }
    };

    dataStream.onerror = function(e) {
        console.error("SSE –æ—à–∏–±–∫–∞");
    };
});
</script>
</body>
</html>