<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üìà –ê–ü–ê–¢–ï–ö ‚Äî –ì—Ä–∞—Ñ–∏–∫–∏</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π CDN —Å UMD-–≤–µ—Ä—Å–∏–µ–π -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #121212;
            color: #e0e0e0;
            font-size: 13px;
            padding: 10px;
        }
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0 12px;
            border-bottom: 1px solid #333;
            margin-bottom: 16px;
        }
        .header-bar h1 {
            font-size: 18px;
            font-weight: 600;
        }
        a {
            color: #64b5f6;
            text-decoration: none;
            font-size: 13px;
        }
        .chart-container {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .chart-wrapper {
            width: 100%;
            height: 250px;
            position: relative;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <h1>üìà –ê–ü–ê–¢–ï–ö ‚Äî –ì—Ä–∞—Ñ–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h1>
        <a href="{{ url_for('index') }}">‚Üê –ù–∞–∑–∞–¥</a>
    </div>

    {% for pid in [1, 2, 3] %}
    <div class="chart-container">
        <h3>–ü—Ä–µ—Å—Å {{ pid }}</h3>
        <div class="chart-wrapper">
            <canvas id="chart{{ pid }}"></canvas>
        </div>
    </div>
    {% endfor %}

    <script>
        // ‚úÖ –ñ–¥—ë–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        document.addEventListener('DOMContentLoaded', function () {
            const dataStream = new EventSource('/stream');
            const maxDataPoints = 100;
            const datasets = {};
            const tempColors = ['#f44336', '#ff9800', '#4caf50', '#2196f3', '#9c27b0', '#ffeb3b', '#00bcd4'];

            // ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
            [1, 2, 3].forEach(pid => {
                const canvas = document.getElementById(`chart${pid}`);
                if (!canvas) {
                    console.error(`‚ùå Canvas chart${pid} –Ω–µ –Ω–∞–π–¥–µ–Ω!`);
                    return;
                }
                console.log(`‚úÖ Canvas chart${pid} –Ω–∞–π–¥–µ–Ω`);

               // –°–æ–∑–¥–∞—ë–º datasets –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–µ—Å—Å–∞
datasets[pid] = {
    labels: Array(maxDataPoints).fill(''),
    datasets: []
};

// 1. –£—Å—Ç–∞–≤–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
datasets[pid].datasets.push({
    label: '–£—Å—Ç–∞–≤–∫–∞',
     Array(maxDataPoints).fill(null),
    borderColor: '#64b5f6',
    borderDash: [5, 5],
    borderWidth: 2,
    fill: false,
    tension: 0.1,
    yAxisID: 'y-temp'
});

// 2‚Äì8. 7 –∑–æ–Ω –Ω–∞–≥—Ä–µ–≤–∞
const tempColors = ['#f44336', '#ff9800', '#4caf50', '#2196f3', '#9c27b0', '#ffeb3b', '#00bcd4'];
for (let i = 0; i < 7; i++) {
    datasets[pid].datasets.push({
        label: `–ó–æ–Ω–∞ ${i+1}`,
         Array(maxDataPoints).fill(null),
        borderColor: tempColors[i],
        borderWidth: 1.5,
        pointRadius: 0,
        fill: false,
        tension: 0.1,
        yAxisID: 'y-temp'
    });
}

// 9. –£—Å—Ç–∞–≤–∫–∞ –¥–∞–≤–ª–µ–Ω–∏—è
datasets[pid].datasets.push({
    label: '–£—Å—Ç. –¥–∞–≤–ª.',
     Array(maxDataPoints).fill(null),
    borderColor: '#8d6e63',
    borderDash: [5, 5],
    borderWidth: 2,
    yAxisID: 'y-pressure'
});

// 10. –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ
datasets[pid].datasets.push({
    label: '–§–∞–∫—Ç

                // –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫
                new Chart(canvas, {
                    type: 'line',
                    data: datasets[pid],
                    options: {
                        maintainAspectRatio: false,
                        devicePixelRatio: 2,
                        scales: {
                            'y-temp': {
                                position: 'left',
                                title: { display: true, text: '–¢–µ–º–ø. (¬∞C)', color: '#64b5f6' },
                                min: 0, max: 200,
                                ticks: { color: '#64b5f6' },
                                grid: { color: 'rgba(100,181,246,0.1)' }
                            },
                            'y-pressure': {
                                position: 'right',
                                title: { display: true, text: '–î–∞–≤–ª. (–ú–ü–∞)', color: '#8d6e63' },
                                min: 0, max: 10,
                                ticks: { color: '#8d6e63' },
                                grid: { drawOnChartArea: false }
                            },
                            x: { ticks: { color: '#bbb' } }
                        },
                        plugins: {
                            legend: { labels: { color: '#e0e0e0' } }
                        }
                    }
                });
            });

            // ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            dataStream.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:", data);

                    data.presses.forEach(p => {
                        const chart = Chart.getChart(`chart${p.id}`);
                        if (!chart) return;

                        const now = new Date().toLocaleTimeString();

                        chart.data.labels.push(now);
                        if (chart.data.labels.length > maxDataPoints) {
                            chart.data.labels.shift();
                        }

                        // –ü—Ä–∏–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        chart.data.datasets[0].data.push(p.temp_target);
                        chart.data.datasets[1].data.push(p.temps[0]);
                        chart.data.datasets[2].data.push(p.pressure);

                        if (chart.data.datasets[0].data.length > maxDataPoints) {
                            chart.data.datasets[0].data.shift();
                            chart.data.datasets[1].data.shift();
                            chart.data.datasets[2].data.shift();
                        }

                        chart.update();
                    });
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ SSE:", e);
                }
            };

            dataStream.onerror = function(e) {
                console.error("SSE –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è");
            };
        });
    </script>
</body>
</html>